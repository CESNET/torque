#! /bin/bash
# $Id: prologue.in,v 1.5 2007/12/10 23:17:01 xdenemar Exp $
#
# Started just before job execution by superior mom

JOBID="$1"
USER="$2"
GROUP="$3"

# GPU handling
CACHE_LIST=/software/pbs-7.0.0/cache/list_cache
CACHE_UPDATE=/software/pbs-7.0.0/cache/update_cache

SCRATCHES="/scratch /scratch.shared /ssd"
for scr in $SCRATCHES;do
        if [ -d $scr ];then
                mkdir -p "$scr/$USER/job_$JOBID" && chown "$USER" "$scr/$USER" && chmod 700 "$scr/$USER/job_$JOBID" && chown "$USER" "$scr/$USER/job_$JOBID"
        fi
done

GPU=$TORQUE_RESC_GPU;

if [ "$GPU" != "" ]; then
	FREE_GPU=`find /dev -user root -name nvidia[0-9]* | wc -l`;
	if [ $GPU -gt $FREE_GPU ]; then # if requested more then present - bail out
		exit 3;
	fi

	rm -f /var/spool/torque/aux/gpu-$JOBID

	while [ $GPU -gt 0 ]; do
		CARD=`find /dev -user root -name nvidia[0-9]* | head -n 1`;
		echo $CARD >>/var/spool/torque/aux/gpu-$JOBID
		chown $USER $CARD;
		chmod 600 $CARD;
		$CACHE_UPDATE arien `hostname`:$CARD gpu_allocation $JOBID;
		let GPU-=1
	done

	chmod 644 /var/spool/torque/aux/gpu-$JOBID &>/dev/null
fi

# Cloud handling

if [ ! -x /usr/sbin/magrathea-cmd ]; then
	exit 0;
fi

# Determine if this is a cluster job, if it is, don't do anything
if [ "$TORQUE_RESC_TOTAL_CLUSTER" != "" ]; then
	exit 0;
fi

if [ $TORQUE_RESC_TOTAL_NODECT -gt 1 ]; then
	preempt=
else
	preempt='-preemptible'
fi

/usr/sbin/magrathea-cmd startjob$preempt "$JOBID" "$TORQUE_RESC_PROC" &>/dev/null
if [ $? -ne 0 ]; then
	exit 2;
fi

exit 0

