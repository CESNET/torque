#!/bin/bash

exec 1>/tmp/log-recheck 2>&1

source /var/spool/torque/mom_scripts/torque-sw-paths.sh
source /var/spool/torque/mom_scripts/torque-scratch-mgr.sh

# LOCAL Scratches
SCRATCHES="/scratch /scratch.ssd"
for scr in $SCRATCHES; do

	UPDATED=

	if [ -d $scr ]; then
		find "$scr/" -maxdepth 2 -type f -name "*.size" | while read x; do

			if [ ! -d "$(dirname $x)/$(basename $x .size)" ]; then
				rm $x;
			fi

			user_dir=$(dirname $x)
			USER=$(basename $user_dir)
			scr=$(dirname $user_dir)
			user_sum=$(dead_quota_user_sum $user_dir)
			$CACHE_UPDATE $SERVER "$USER@`hostname`:$scr" scratch_leftover $user_sum;

			UPDATED=1
		done

		if [ ! -z $UPDATED ]; then
			dead_quota_sum $scr >$scr/.dead.size
		fi

	fi

done

$CACHE_LIST $SERVER scratch_leftover | grep $(hostname) | grep -v scratch.shared | cut -f1 | while read x; do

	filename=$(echo $x | cut -d@ -f2 | cut -d: -f2);

	if [ ! -f $filename ]; then
		$CACHE_DELETE $SERVER $x scratch_leftover
	fi

done

