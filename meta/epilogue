#!/bin/bash


JOBID="$1"
USER="$2"

SCRATCHES="/scratch /scratch.shared /scratch.ssd"
for scr in $SCRATCHES;do
        if [ -d "$scr/$USER/job_$JOBID" ];then
		du -sk $scr/$USER/job_$JOBID 2>&1| sed 's/\t/ /'| logger -t pbs_scratch_usage -p local0.info
                rmdir --ignore-fail-on-non-empty "$scr/$USER/job_$JOBID" 2>/dev/null
        fi
done

# GPU support
CACHE_LIST=/software/pbs-7.0.0/cache/list_cache
CACHE_UPDATE=/software/pbs-7.0.0/cache/update_cache

HOST=`hostname`
for i in `$CACHE_LIST arien gpu_allocation | grep $JOBID | sed -n 's/'$HOST'://p' | cut -f1`; do
	chmod 666 $i;
	chown root:root $i;
	$CACHE_UPDATE arien `hostname`:$i gpu_allocation unallocated;
done

/var/spool/torque/mom_priv/torque-gpu-mgr.sh $JOBID rls

# Cloud support

if [ ! -x /usr/sbin/magrathea-cmd ]; then
	exit 0;
fi

# Determine if this is a cluster job, if it is, don't do anything
if [ "$TORQUE_RESC_TOTAL_CLUSTER" != "" ]; then
	exit 0;
fi

/usr/sbin/magrathea-cmd stopjob "$JOBID" >&/dev/null
