#!/bin/sh
# torque.setup

# USAGE:  torque.queue.setup <USERNAME> <QUEUE1> <QUEUE2> [<HOSTNAME>]

if [ "$3" = "" ] ; then
  echo "USAGE:  torque.queue.setup <USERNAME> <QUEUE1> <QUEUE2> [<HOSTNAME>]"
  exit 1
  fi

if [ "$4" = "" ] ; then
  # validate hostname matches DNS
  HOSTNAME=`hostname`
else
  HOSTNAME=$4
fi
  
# enable operator privileges

USER=$1@$HOSTNAME

# QUEUES
QUEUE1=$2;
QUEUE2=$3;

echo "initializing TORQUE (admin: $USER)"

ps -ef | grep -v grep | grep pbs_server 

if [ "$?" -eq "0" ] ; then
  echo "ERROR: pbs_server already running... run 'qterm' to stop pbs_server and rerun"
  exit 1;
fi

pbs_server -t create

echo set server operators += $USER | qmgr

if [ "$?" -ne "0" ] ; then
  echo "ERROR: cannot set TORQUE admins"
  qterm
  exit 1;
fi

echo set server managers += $USER | qmgr


qmgr -c 'set server scheduling = true'
qmgr -c 'set server keep_completed = 300'
qmgr -c 'set server mom_job_sync = true'

# create default queue

qmgr -c "create queue $QUEUE1"
qmgr -c "set queue $QUEUE1 queue_type = execution"
qmgr -c "set queue $QUEUE1 started = true"
qmgr -c "set queue $QUEUE1 enabled = true"
qmgr -c "set queue $QUEUE1 resources_default.walltime = 1:00:00"
qmgr -c "set queue $QUEUE1 resources_default.nodes = 1"

qmgr -c "set server default_queue = $QUEUE1"

# create the second queue
qmgr -c "create queue $QUEUE2"
qmgr -c "set queue $QUEUE2 queue_type = execution"
qmgr -c "set queue $QUEUE2 started = false"
qmgr -c "set queue $QUEUE2 enabled = false"
qmgr -c "set queue $QUEUE2 resources_default.walltime = 1:00:00"
qmgr -c "set queue $QUEUE2 resources_default.nodes = 1"
qmgr -c "set queue $QUEUE2 resources_max.cput = 10:10:10"
qmgr -c "set queue $QUEUE2 resources_max.mem = 2044mb"
qmgr -c "set queue $QUEUE2 resources_max.walltime = 10:10:10"
qmgr -c "set queue $QUEUE2 resources_max.nodect = 10"
qmgr -c "set queue $QUEUE2 max_running = 2"



