/* this file contains functions for manipulating job arrays

  included functions:

  is_array() determine if jobnum is actually an array identifyer

 */

#include <pbs_config.h>   /* the master config generated by configure */

#include <stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>


#include "pbs_ifl.h"
#include "list_link.h"
#include "attribute.h"
#include "server_limits.h"
#include "job.h"
#include "log.h"
/* #include "array.h" */

#ifndef TRUE
#define TRUE 1
#define FALSE 0
#endif

/* global data items used */

/* list of job arrays */

extern tlist_head svr_jobarrays;
extern char *path_arrays;

/* search job array list to determine if id is a job array */
int is_array(char *id)
  {
  
  char *at;

  array_job_list *pajl;
  
  if ((at = strchr(id,(int)'@')) != NULL)
    *at = '\0'; /* strip off @server_name */
    
  
    
  pajl = (array_job_list*)GET_NEXT(svr_jobarrays);  
  while (pajl != NULL)
    {
    if (strcmp(pajl->ai_qs.parent_id, id) == 0)
      {
      if (at)
        *at = '@';  /* restore @server_name */
	
      return TRUE;
      }
    pajl = (array_job_list*)GET_NEXT(pajl->all_arrays);
    }
  
  if (at)
    *at = '@';  /* restore @server_name */
    
  return FALSE;
  

  }
  
  
int array_save(array_job_list *pajl)

  { 
  int fds;
  int openflags;
  char namebuf[MAXPATHLEN];
  
  strcpy(namebuf, path_arrays);
  strcat(namebuf, pajl->ai_qs.fileprefix);
  strcat(namebuf, ARRAY_FILE_SUFFIX);
  
  
  openflags =  O_WRONLY | O_SYNC | O_CREAT;
  fds = open(namebuf, openflags, 0600);
  
  if (fds < 0)
    {
    
    return -1;
    }
    
    
  write(fds,  &(pajl->ai_qs), sizeof(pajl->ai_qs));
    
  close(fds);
  
  return 0;
  }
  

